#!/bin/bash

PATH_TO_SCRIPT=$(dirname $0)

die () {
    echo >&2 "$@"
    exit
}

if [ -f $PATH_TO_SCRIPT/.env ]
then
  export $(cat $PATH_TO_SCRIPT/.env | sed 's/#.*//g' | xargs)
else
  die "Missing .env"
fi

if [ ! -f $PATH_TO_SCRIPT/$PEMFILE ] || [ ! $PATH_TO_SCRIPT/$PEMFILE ]; then
  die ".pem key file missing"
fi

if [ $# -eq 0 ]
  then
    die "No arguments supplied.  Please specify a plugin name."
fi

if [ ! -d "$PATH_TO_SCRIPT/../wordpress/wp-content/plugins/$1" ]; then
  die "Plugin doesn't exist"
fi

rsync -avL --progress --exclude "node_modules" -e "ssh -i $PATH_TO_SCRIPT/$PEMFILE" $PATH_TO_SCRIPT/../wordpress/wp-content/plugins/$1 $SERVER_URL:/opt/bitnami/apps/wordpress/htdocs/wp-content/plugins/